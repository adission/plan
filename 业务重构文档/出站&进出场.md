### 出站功能整理
#### 一、校验
+ 当前时间与消息中的出站时间之差大于160S直接丢弃，且没有记录日志

#### 二、公共接口
+ 1、当前时间与UTC时间相差8小时的处理函数
```
入参：当前时间（计算UTC时间传入）或UTC时间（计算当前时间传入）
返回：UTC时间或当前时间
```
+ 2、获取执行日期
```
入参：跨天线路的设置时间
返回：执行表的日期
```
#### 三、内部可拆分小功能
+ 1、环线手动签点（现有逻辑中查询车辆资源和上下行计划标都是重复操作）
```
入参：车辆资源对象、计划对象
返回：JSON串{'data':xxx, 'code':xxx, 'msg':xxx}
```
+ 2、单头调改变方向
```
入参：车辆资源对象、车辆资源的方向与设备上传的方向是否相同
返回：JSON串{'data':xxx, 'code':xxx, 'msg':xxx}
```
+ 3、整合日志数据、日志写入redis，本日志可以和进出场日志类似使用异步的方式写入
```
入参：数据字典
返回：JSON串{'data':xxx, 'code':xxx, 'msg':xxx}
```

####  四、消息推送
+ 1、单头调车辆改变方向时推送线路在途状态更新包（2次：上行去掉/下行添加，或下行去掉/上行添加）
+ 2、推送出站消息至前端（内部消息主题生产，然后推送）

#### 五、存在的问题
+ 1、当前时间与消息中的出站时间之差大于160S直接丢弃，且没有记录日志
+ 2、出站日志没有使用异步方式写入redis
+ 3、如果是单头调，车辆资源的同一条数据会被write2次
----
### 进出场功能整理
#### 一、校验
+ 1、车速为0判定为漂移
+ 2、线路车辆资源不存在
+ 3、车辆为非运营状态
+ 4、没有计划无法进出场
+ 5、该线路没有调度配置和通用配置
+ 6、该车场不是该线路的始发车场
+ 7、双向线路：上行单头调不能进出下行场/下行单头调不能进出上行场
+ 8、该计划已被执行
+ 9、未在出场带走计划的范围内出场
+ 10、车辆已出场
+ 11、出场过程发生异常
+ 12、重复进场
+ 13、双头调异常带点返回
+ 14、进场过程发生异常
+ 15、不满足最小进场时间要求

#### 二、公共接口
+ 1、当前时间与UTC时间相差8小时的处理函数
```
入参：当前时间（计算UTC时间传入）或UTC时间（计算当前时间传入）
返回：UTC时间或当前时间
```
+ 2、获取执行日期
```
入参：跨天线路的末班时间
返回：执行表的日期
```
+ 3、日期、日期时间格式化问题相关接口
```
入参：一种格式的日期
返回：返回另一种格式的日期
```
+ 4、获取车辆资源
```
入参：设备号、执行日期、线路编码
返回：车辆资源对象
```
#### 三、内部可拆分小功能
+ 1、灵活调回场自动添加计划功能（车辆资源信息同步）
+ 2、进场后站序清零、预测数据清零
+ 3、包车任务（调用了车辆资源信息同步）
+ 4、双头掉异常带点返回
+ 5、进出场日志
####  四、消息推送
+ 1、灵活调自动返回推送：线路在途状态更新包、车场状态更新包（不带计划时车辆还在对应车场的清除/回到对应车场的添加）、单班次行车计划下发包、车辆统计数实时变更反馈包
+ 2、车辆资源信息同步推送（根据相关条件推送）：车辆在线/离线信息包、线路在途状态更新包、线路车场状态更新包、车辆资源状态信息包、车辆统计数实时变更反馈包
+ 3、包车推送：线路车场状态更新包，下行消息：下达任务指令、设置车载机运营属性
+ 4、双向双头调出场推送（调用start_bus接口）：计划列表更新包、车辆实时位置包、线路车场状态更新包、线路在途状态更新包、车辆统计数实时变更反馈包、提前/延后发车、到点未发车消息推送
+ 5、双向双头调进场推送（调用back_bus_operation，back_bus_operation又调用了车辆资源信息同步）：线路车场状态更新包、计划列表更新包（带点返回）、下行进场任务包、线路在途状态更新包、单班次行车计划下达包、车辆统计数实时变更反馈包
#### 五、存在的问题
+ 1、现有已拆分的小功能不够合理（小功能不够独立，相互之间仍然存在交叉）
+ 2、消息推送存在多处重复
+ 3、数据库读写存在多处重复、校验存在重复
+ 4、没有对城市、公司的消息验证过滤
+ 5、重构应注意如下情景：
```
双向双头调
双向单头调
灵活调
包车开始/结束
双头调异常带点返回
```
----
```
双向线路单头调/双头调车辆出场：
1、验证：
车速为零被判定为漂移
该线路不存在该车辆资源
车辆为非运营状态
没有计划无法进出场
该线路没有调度配置和通用配置
该车场不是该线路的始发车场
单头调时：上行单头调不能进出下行场/下行单头调不能进出上行场
该计划已被执行
车辆已出场
未在出场带走计划的范围内出场
场内停留时间不足出场

2、发车：start_bus
A、校验：
计划车辆还未进入对应车场
机动车辆不能执行计划
异常状态车辆不能执行计划
任务状态车辆不能执行计划
B、判断车辆是否已有计划，有就取消，没有直接带指定计划出场
C、计划表、车辆资源表写库操作
D、车辆实时位置消息推送
E、添加调度日志
F、计划列表更新包、线路车场状态更新包、线路在途状态更新包、车辆统计数实时变更反馈包、提前/延后发车、到点未发车消息推送
G、车辆资源信息同步，这里会根据相关条件推送不同的消息包，可能和F步的消息推送有重复
H、更新新车记录
I、写入趟次

包车车辆出场：
1、验证：
车速为零被判定为漂移
该线路不存在该车辆资源
车辆为非运营状态
没有计划无法进出场
该线路没有调度配置和通用配置
该车场不是该线路的始发车场
单头调时：上行单头调不能进出下行场/下行单头调不能进出上行场
该计划已被执行
未在出场带走计划的范围内出场
场内停留时间不足出场

2、包车开始：enter_yard
3、根据任务类型进行相关操作（退出运营）
4、添加非运营记录
5、车辆资源写库
6、线路车场状态更新包
7、下行任务消息包、设置车载机运营属性
8、车辆资源信息同步
----
双向线路单头调/双头调车辆回场：
1、验证：
车速为零被判定为漂移
该线路不存在该车辆资源
车辆为非运营状态
没有计划无法进出场
该线路没有调度配置和通用配置
该车场不是该线路的始发车场
单头调时：上行单头调不能进出下行场/下行单头调不能进出上行场
该计划已被执行
重复进场

2、回场后站序和预测数据清零
3、线路车场状态更新
4、手动返回：back_bus_operation
1）验证：
处理返回出错, 车在场内
无计划返回
计划不存在，无法回场
2）进场后预测数据清零
3）判断是否有上行在途下行计划、或者下行在途上行计划
4）判断是否为包车的带点返回
5）计划表写库
6）计划列表更新
7）进场任务
8）线路在途状态更新
9）插入运营记录
10）车辆资源写库
11）车辆资源趟次写入
12）写入调度日志
13）单班次行车计划下达包、线路车场状态更新包、车辆统计数变更实时反馈包
14）车辆资源信息同步
5、异步写日志


双头调异常带点返回：
1、验证：
车速为零被判定为漂移
该线路不存在该车辆资源
车辆为非运营状态
没有计划无法进出场
该线路没有调度配置和通用配置
该车场不是该线路的始发车场
单头调时：上行单头调不能进出下行场/下行单头调不能进出上行场
该计划已被执行
重复进场

2、回场后站序和预测数据清零
3、线路车场状态更新
4、异常带点返回：back_bus_operation
1）验证：
处理返回出错, 车在场内
无计划返回
计划不存在，无法回场
2）进场后预测数据清零
3）判断是否有上行在途下行计划、或者下行在途上行计划
4）判断是否为包车的带点返回
5）计划表写库
6）计划列表更新
7）进场任务
8）线路在途状态更新
9）插入运营记录
10）车辆资源写库
11）车辆资源趟次写入
12）写入调度日志
13）单班次行车计划下达包、线路车场状态更新包、车辆统计数变更实时反馈包
14）车辆资源信息同步
5、异步写日志


灵活调回场：
1、验证：
车速为零被判定为漂移
该线路不存在该车辆资源
车辆为非运营状态
没有计划无法进出场
该线路没有调度配置和通用配置
该车场不是该线路的始发车场

2、灵活调：smart_back_bus
1）线路在途状态更新包、线路车场状态更新包
2）添加计划
3）单班次行车计划下达包、线路车场状态更新包、车辆统计数变更实时反馈包
4）车辆资源信息同步

```